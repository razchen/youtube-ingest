services:
  paddleocr:
    build:
      context: ./ocr
      dockerfile: Dockerfile
    image: paddleocr-api:latest
    container_name: paddleocr-api
    working_dir: /app
    volumes:
      - ./ocr/server.py:/app/server.py:ro
      - paddle_cache:/root/.paddleocr
    environment:
      PYTHONUNBUFFERED: '1'
    ports:
      - '8000:8000'
    healthcheck:
      test:
        [
          'CMD',
          'python',
          '-c',
          "import urllib.request,sys; sys.exit(0) if urllib.request.urlopen('http://127.0.0.1:8000', timeout=5).status==200 else sys.exit(1)",
        ]
      interval: 20s
      timeout: 5s
      retries: 15
      start_period: 90s
    restart: unless-stopped

  vision:
    build:
      context: ./vision
    image: ziporen-vision:latest
    restart: unless-stopped
    ports:
      - '8081:8081'
    environment:
      OBJ_WEIGHTS: /app/models/yolov8n.pt
      FACE_WEIGHTS: /app/models/yolov8n-face.pt
      PYTHONUNBUFFERED: '1'

    volumes:
      - vision_models:/app/models

volumes:
  paddle_cache:
  vision_models:
